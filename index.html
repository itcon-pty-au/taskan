<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TasKan - Offline first task tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css" />
  <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script type="text/javascript" src="https://unpkg.com/moment/min/moment.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-data/peer/umd/vis-data.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vis-timeline/peer/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

  <script>
    const { Timeline, DataSet } = vis;
  </script>

  <style>
    :root {
      --bg-color: #f4f4f4;
      --text-color: #000000;
      --card-bg: #ffffff;
      --item-bg: #e9ecef;
      --item-hover: #dee2e6;
      --border-color: #ddd;
      --header-bg: #f8f9fa;
      --project-bg-1: #f0f0f0;
      --project-bg-2: #f0f0f0;
      --date-scheme: light;
      --date-picker-filter: none;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: #2d2d2d;
      --item-bg: #3d3d3d;
      --item-hover: #4d4d4d;
      --border-color: #404040;
      --header-bg: #2a2a2a;
      --project-bg-1: #1a1a1a;
      --project-bg-2: #1a1a1a;
      --date-scheme: dark;
      --date-picker-filter: invert(1);
    }

    [data-theme="light"] {
      --date-scheme: light;
    }

    .editable {
      border: none;
      outline: none;
      min-width: 50px;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      font-size: 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      padding: 15px;
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow-y: auto;
    }

    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .top-menu button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .projects-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      flex: 1;
    }

    .project {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      background-color: var(--card-bg);
      display: flex;
      flex-direction: column;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }

    .project-header .editable {
      cursor: pointer;
      border: none;
      background-color: transparent;
      font-size: 1.2em;
      padding: 5px;
      outline: none;
      transition: border-bottom 0.2s;
    }

    .lists-container {
      display: flex;
      gap: 15px;
      padding-top: 10px;
    }

    .highlight {
      background-color: #f0f8ff;
    }

    .list {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg);
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      gap: 5px;
      position: relative;
    }

    .list-header .rearrange-buttons {
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      gap: 5px;
      color: var(--text-color);
      opacity: 0.5;
      font-size: 0.9em;
      align-items: center;
      position: absolute;
      left: 10px;
      z-index: 1;
      width: 40px;
    }

    .list-header:hover .rearrange-buttons {
      opacity: 1;
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
    }

    .rearrange-buttons i:hover {
      opacity: 1;
    }

    .list-items {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;
      position: relative;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .list-item:hover {
      background-color: var(--item-hover);
    }

    .drop-highlight {
      background-color: #f0f8ff;
    }

    .list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .list-item.todo-item .item-name {
      flex: 1;
    }

    .list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .add-item-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .add-item {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
      flex: 1;
    }

    .add-item:hover {
      background-color: var(--item-hover);
    }

    .add-list {
      cursor: pointer;
      background: none;
      text-align: center;
      padding: 10px;
      border: dashed 1px;
      border-radius: 5px;
      color: #6c757d;
    }

    .add-list:hover {
      background-color: var(--item-hover);
    }

    .dragging {
      opacity: 0.5;
      cursor: move;
    }

    .drop-placeholder {
      height: 2px;
      background-color: var(--text-color);
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
      opacity: 0.3;
      border-radius: 1px;
    }

    .drop-placeholder::before,
    .drop-placeholder::after {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      background-color: var(--text-color);
      border-radius: 50%;
      top: -2px;
      opacity: 0.3;
    }

    .drop-placeholder::before {
      left: -3px;
    }

    .drop-placeholder::after {
      right: -3px;
    }

    .list-items {
      min-height: 50px;

      padding: 10px;
    }

    .list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .delete-confirm:hover {
      background-color: #000 !important;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }

    .todo-checkbox {
      accent-color: #28a745;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .list-item button {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .list-item:hover button {
      opacity: 1;
    }

    #themeToggleBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #themeToggleBtn:hover {
      background-color: #000;
    }

    [data-theme="dark"] #themeToggleBtn:hover {
      background-color: #666;
    }

    .item-hover-menu {
      position: absolute;
      top: -30px;
      right: 10px;
      background-color: var(--card-bg);
      padding: 3px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: none;
      gap: 5px;
      z-index: 100;
      align-items: center;
      transition: width 0.2s ease;
    }

    .item-hover-menu button {
      padding: 3px 6px;
      background-color: var(--item-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      transition: width 0.2s ease;
    }

    .item-hover-menu button.delete-confirm {
      width: auto;
      padding: 3px 10px;
      white-space: nowrap;
    }

    .list-item:hover .item-hover-menu {
      display: flex;
    }

    .item-hover-menu input[data-coloris] {
      position: absolute;
      visibility: hidden;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      pointer-events: none;
      opacity: 0;
    }

    .item-hover-menu button:hover {
      background-color: var(--item-hover);
    }

    .item-hover-menu button i {
      font-size: 14px;
    }

    .item-hover-menu button[data-coloris] {
      padding: 3px 6px !important;
      width: 28px !important;
      height: 28px !important;
      background-color: var(--item-bg) !important;
    }

    .add-list {
      display: none;
    }

    .add-list-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .add-list-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .add-list-btn:hover {
      background-color: #666;
    }

    .project-header button,
    .list-header button {
      padding: 5px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-left: 5px;
      transition: width 0.2s ease;
    }

    .project-header button i,
    .list-header button i {
      font-size: 12px;
    }

    .project-header button.delete-confirm,
    .list-header button.delete-confirm {
      width: auto;
      padding: 5px 8px;
      font-size: 12px;
    }

    .project-header button:hover,
    .list-header button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .project-header button:hover,
    [data-theme="dark"] .list-header button:hover {
      background-color: #666;
    }

    .list.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .top-menu button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .top-menu button:hover {
      background-color: #666;
    }

    #coffeeBtn {
      color: #fff;
      text-decoration: none;
      display: inline-block;
    }

    .rearrange-buttons {
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      gap: 5px;
      color: var(--text-color);
      opacity: 0.5;
      font-size: 0.9em;
      position: relative;
      margin-right: 8px;
    }

    .list-header {
      position: relative;
    }

    .list-header:hover .rearrange-buttons {
      opacity: 1;
    }

    button:disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    .editor-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(3px);
    }

    .editor-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      height: 90vh;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 0 0 1px var(--border-color),
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 12px 40px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-popup .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--header-bg);
      border-radius: 12px 12px 0 0;
    }

    .editor-popup .due-date-container {
      border-bottom: 1px solid var(--border-color);
      background: var(--header-bg);
    }

    [data-theme="dark"] .editor-popup {
      box-shadow: 0 0 0 1px var(--border-color),
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 12px 40px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .editor-overlay {
      background: rgba(0, 0, 0, 0.7);
    }

    .editor-popup #summernote {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .editor-popup .note-editor {
      display: flex !important;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      width: 100%;
      overflow: hidden;
    }

    .editor-popup .note-editing-area {
      flex: 1;
      display: flex !important;
      flex-direction: column;
      min-height: 0 !important;
    }

    .editor-popup .note-editable {
      flex: 1 !important;
      min-height: 0 !important;
      height: 100% !important;
    }

    .editor-popup .editor-header .close-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .editor-popup .editor-header .close-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .editor-popup .editor-header .close-btn:hover {
      background-color: #666;
    }

    .editor-popup .editor-header .close-btn i {
      font-size: 14px;
    }

    .note-editor .note-editable {
      background-color: var(--card-bg) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-toolbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-toolbar .note-btn:not(.note-color-btn) {
      background-color: var(--item-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 2px !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn:hover {
      border-color: #000 !important;
    }

    [data-theme="dark"] .note-editor .note-color-palette .note-color-row .note-color-btn:hover {
      border-color: #fff !important;
    }

    .note-editor .note-color-palette {
      padding: 5px !important;
      background-color: var(--card-bg) !important;
    }

    .note-editor .note-color-reset {
      padding: 5px 8px !important;
      margin: 5px !important;
      width: calc(100% - 10px) !important;
      background-color: var(--item-bg) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-reset:hover {
      background-color: var(--item-hover) !important;
    }

    .note-editor.note-frame {
      display: flex !important;
      flex-direction: column;
      height: 100% !important;
      min-height: 0 !important;
    }

    .note-editor .note-status-output,
    .note-editor .note-statusbar {
      background-color: var(--header-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-color) !important;
      display: none !important;
    }

    .note-editor .note-dropdown-menu {
      background-color: var(--card-bg) !important;
      border-color: var(--border-color) !important;
    }

    .note-editor .note-dropdown-item {
      color: var(--text-color) !important;
    }

    .note-editor .note-dropdown-item:hover {
      background-color: var(--item-hover) !important;
    }

    [data-coloris] {
      padding: 5px !important;
      width: auto !important;
      height: auto !important;
      border: none !important;
      background: none !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    [data-coloris]::before {
      display: none !important;
    }

    .color-picker-btn .fa-paintbrush {
      font-size: 14px !important;
      color: var(--text-color) !important;
      display: inline-block !important;
      pointer-events: none !important;
    }

    .item-link {
      color: #0066cc;
      text-decoration: underline;
      cursor: pointer;
    }

    .item-link:hover {
      color: #0052a3;
    }

    [contenteditable="true"] .item-link {
      color: inherit;
      text-decoration: none;
      cursor: text;
    }

    .sub-list {
      margin: 10px 0;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--card-bg);
      overflow: hidden;
      cursor: move;
    }

    .sub-list.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .sub-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .sub-list-header button {
      padding: 5px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-left: 5px;
      transition: width 0.2s ease;
    }

    .sub-list-header button i {
      font-size: 12px;
    }

    .sub-list-header button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .sub-list-header button:hover {
      background-color: #666;
    }

    .sub-list-header button.delete-confirm {
      width: auto;
      padding: 5px 8px;
      font-size: 12px;
    }

    .sub-list-items {
      padding: 10px;
      min-height: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sub-list-item {
      background-color: var(--item-bg);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
      cursor: move;

      position: relative;
    }

    .sub-list-item:hover {
      background-color: var(--item-hover);
    }

    .sub-list-item.todo-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sub-list-item.todo-item .item-name {
      flex: 1;
    }

    .sub-list-item.todo-item .item-name.strikethrough {
      text-decoration: line-through;
      color: gray;
    }

    .sub-list-item.shift-up {
      transform: translateY(-100%);
      transition: transform 0.2s ease;
    }

    .sub-list-item.shift-down {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .sub-list-item.drop-highlight {
      background-color: #f0f8ff;
    }

    .sub-list-item.dragging {
      opacity: 0.5;
      cursor: move;
    }

    .sub-list-item.drop-placeholder {
      height: 2px;
      background-color: #555555;
      margin: 10px 0;
      transition: all 0.2s ease;
      position: relative;
    }

    .sub-list-item.drop-placeholder::before {
      content: "";
      position: absolute;
      left: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .sub-list-item.drop-placeholder::after {
      content: "";
      position: absolute;
      right: -5px;
      top: -4px;
      width: 10px;
      height: 10px;
      background-color: #555555;
      border-radius: 50%;
    }

    .time-tracker {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 5px;
    }

    .elapsed-time {
      min-width: 60px;
      font-family: monospace;
      font-size: 0.9em;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .history-table th,
    .history-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid var(--border-color);
    }

    .history-table th {
      background-color: var(--header-bg);
    }

    .history-search {
      width: calc(100% - 16px);
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .history-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 1000px;
      height: 80%;
      background: var(--card-bg);
      z-index: 1000;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    .history-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .history-modal .close-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .history-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .history-modal .cleanup-btn {
      padding: 5px 10px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .history-modal .cleanup-btn:hover {
      background-color: #bd2130;
    }

    .projects-container .project:nth-child(odd) {
      background-color: var(--project-bg-1);
    }

    .projects-container .project:nth-child(even) {
      background-color: var(--project-bg-2);
    }

    .timeline-container {
      margin: 15px 0;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .timeline {
      height: 100px;
      background-color: var(--card-bg);
    }

    .vis-timeline {
      border: none;
      background-color: var(--card-bg);
    }

    .vis-item {
      background-color: var(--item-bg);
      border-color: var(--border-color);
      color: var(--text-color);
      border-width: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .vis-item.vis-selected {
      background-color: var(--item-bg);
      border-color: var(--border-color);
    }

    .vis-item:hover {
      background-color: var(--item-bg);
      border-color: var(--border-color);
    }

    .vis-tooltip {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-color);
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .vis-time-axis .vis-text {
      color: var(--text-color);
    }

    .vis-time-axis .vis-grid.vis-minor {
      border-color: var(--border-color);
      opacity: 0.8;
      height: 30px !important;
    }

    .project-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      width: 80%;
      max-width: 600px;
    }

    .project-form input[type="text"],
    .project-form input[type="date"] {
      width: calc(100% - 24px);
      padding: 8px 12px;
      margin: 5px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .milestones-container {
      margin: 15px 0;
    }

    .milestone-entry {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .milestone-entry input {
      flex: 1;
    }

    .form-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 0;
      gap: 10px;
    }

    .form-buttons button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .form-buttons button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .form-buttons button:hover {
      background-color: #666;
    }

    .form-buttons button i {
      font-size: 14px;
    }

    .remove-milestone-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .remove-milestone-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .remove-milestone-btn:hover {
      background-color: #666;
    }

    .remove-milestone-btn i {
      font-size: 14px;
    }

    .form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .timeline-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 10;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease, width 0.2s ease,
        background-color 0.2s ease;
      opacity: 0;
    }

    .timeline-container:hover .timeline-delete-btn {
      opacity: 1;
    }

    .timeline-delete-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .timeline-delete-btn:hover {
      background-color: #666;
    }

    .timeline-delete-btn.delete-confirm {
      width: auto;
      opacity: 1;
      padding: 5px 10px;
    }

    .vis-time-axis .vis-text {
      color: var(--text-color);
      opacity: 0.4;
    }

    .vis-time-axis .vis-grid.vis-major {
      border-color: var(--border-color);
      opacity: 0.7;
      border-width: 3px;
      height: 100% !important;
    }

    .vis-item-content {
      position: relative;
      color: var(--text-color);
      opacity: 0.8;
      font-size: 0.9em;
      padding: 2px 5px;
      transition: opacity 0.2s ease;
    }

    .vis-item:hover {
      opacity: 1;
    }

    .timeline {
      height: 100px;
      background-color: var(--card-bg);
      width: 100%;
      overflow-x: hidden;
    }

    .vis-time-axis .vis-grid.vis-minor {
      border-color: var(--border-color);
      opacity: 0.4;
    }

    .vis-time-axis .vis-grid.vis-major {
      border-color: var(--border-color);
      opacity: 0.7;
      border-width: 3px;
      height: 100% !important;
    }

    .vis-item {
      z-index: 2;
    }

    [data-theme="dark"] .vis-time-axis .vis-grid.vis-minor {
      opacity: 0.8;
    }

    [data-theme="dark"] .vis-time-axis .vis-grid.vis-major {
      opacity: 0.7;
    }

    .vis-current-time {
      background-color: #ff4444;
      width: 2px;
      z-index: 1;
    }

    .vis-item.vis-dot {
      display: none !important;
    }

    .vis-item.vis-point {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }

    .timeline-delete-btn i {
      font-size: 14px;
    }

    .project-form input[type="date"] {
      color-scheme: var(--date-scheme);
    }

    [data-theme="dark"] {
      --date-scheme: dark;
    }

    [data-theme="light"] {
      --date-scheme: light;
    }

    .milestones-container h3 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .add-milestone-btn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .add-milestone-btn:hover {
      background-color: #000;
    }

    [data-theme="dark"] .add-milestone-btn:hover {
      background-color: #666;
    }

    .add-milestone-btn i {
      font-size: 14px;
    }

    .project-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .project-form-header .form-buttons {
      margin-top: 0;
    }

    .remove-milestone {
      color: var(--text-color);
      opacity: 0.5;
      cursor: pointer;
      font-size: 18px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-milestone:hover {
      opacity: 1;
    }

    .note-editor .note-color-palette .note-color-row .note-color-btn {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 2px !important;
    }

    .note-editor .note-color-palette {
      padding: 5px !important;
    }

    .note-editor .note-color-reset {
      padding: 5px 8px !important;
      margin: 5px !important;
      width: calc(100% - 10px) !important;
      background-color: var(--item-bg) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color) !important;
    }

    .note-editor .note-color-reset:hover {
      background-color: var(--item-hover) !important;
    }

    @keyframes pulseButton {
      0% {
        transform: scale(1);
        background-color: #ff4444;
      }

      50% {
        transform: scale(1.05);
        background-color: #ff0000;
      }

      100% {
        transform: scale(1);
        background-color: #ff4444;
      }
    }

    #autoBackupBtn {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #autoBackupBtn.needs-backup {
      animation: pulseButton 2s infinite;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .logo {
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo h1 {
      font-size: 1.2em;
      font-weight: 700;
      margin: 0;
      color: var(--text-color);
      letter-spacing: 0;
    }

    .logo .tagline {
      font-size: 0.8em;
      color: var(--text-color);
      opacity: 0.7;
      font-style: italic;
      margin-top: 2px;
    }

    .top-menu-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .footer {
      text-align: center;
      padding: 10px 0;
      margin-top: auto;
      color: var(--text-color);
      opacity: 0.7;
      font-size: 0.9em;
    }

    .footer .heart {
      color: #ff4444;
      display: inline-block;
      font-size: 1.5em;
      position: relative;
      top: 2px;
      animation: heartbeat 1.5s ease infinite;
    }

    @keyframes heartbeat {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
    }

    .rearrange-buttons i:hover {
      opacity: 1;
    }

    .list-header-content {
      display: flex;
      align-items: center;
      flex: 1;
      margin-left: 50px;
    }

    .list-header .editable {
      flex: 1;
      min-width: 0;
    }

    .list:first-child .list-header .rearrange-buttons {
      width: 20px;
    }

    .list:last-child .list-header .rearrange-buttons {
      width: 20px;
    }

    .list:first-child .list-header-content {
      margin-left: 30px;
    }

    .list:last-child .list-header-content {
      margin-left: 30px;
    }

    .rearrange-buttons i {
      padding: 4px;
      transition: opacity 0.2s ease;
      width: 16px;
      text-align: center;
    }

    .backup-nudge {
      animation: nudge 1s ease-in-out infinite;
      position: relative;
      background-color: #ffd700 !important;
      color: black !important;
    }

    @keyframes nudge {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-3px);
      }

      75% {
        transform: translateX(3px);
      }
    }

    .read-more-btn {
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 0.8em;
      background-color: var(--item-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }

    .read-more-btn:hover {
      background-color: var(--item-hover);
    }

    .history-table td {
      max-width: 400px;
      vertical-align: top;
    }

    .delete-history-btn {
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 0.8em;
      background-color: transparent;
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .delete-history-btn:hover {
      opacity: 1;
      color: #ff4444;
    }

    .history-table td {
      position: relative;
    }

    .history-table tr:hover .delete-history-btn {
      opacity: 0.8;
    }

    .action-column {
      width: 50px;
      text-align: center;
    }

    .delete-history-btn {
      padding: 4px 8px;
      font-size: 0.9em;
      background-color: transparent;
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .delete-history-btn:hover {
      opacity: 1;
      color: #ff4444;
    }

    .history-table tr:hover .delete-history-btn {
      opacity: 0.8;
    }

    .due-date-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px 20px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
      margin: 0;
    }

    .due-date-container label {
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .due-date-container input[type="date"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      color-scheme: var(--date-scheme);
      font-size: 14px;
    }

    .due-date-container input[type="date"]::-webkit-calendar-picker-indicator {
      filter: var(--date-picker-filter);
      cursor: pointer;
      padding: 4px;
      margin-right: -4px;
      opacity: 0.7;
      color: var(--text-color);
    }

    .list-item.due-soon {
      position: relative;
      overflow: visible;
    }

    .list-item.due-soon::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ffd700;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
      z-index: 2;
    }

    .list-item.overdue {
      position: relative;
      overflow: visible;
    }

    .list-item.overdue::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ff4444;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 68, 68, 0.8);
      z-index: 2;
    }

    .due-date-info {
      margin-left: 8px;
      font-size: 0.85em;
      opacity: 0.9;
      font-style: italic;
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      display: inline-block;
    }

    .list-item.due-soon .due-date-info {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }

    .list-item.overdue .due-date-info {
      color: #ff4444;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }

    .task-content {
      display: inline-block;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .truncated-text {
      display: inline;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .full-text {
      display: none;
    }

    .history-table td {
      word-break: break-word;
      line-height: 1.4;
    }

    .history-table .read-more-btn {
      background: none;
      border: none;
      color: #0066cc;
      cursor: pointer;
      padding: 0;
      font-size: 0.9em;
      margin-left: 5px;
    }

    .history-table .read-more-btn:hover {
      text-decoration: underline;
    }

    .note-editor .note-statusbar {
      display: none !important;
    }

    .note-editor.note-frame {
      height: calc(100% - 50px) !important;
    }

    .note-editing-area {
      height: calc(100% - 40px) !important;
    }

    .note-editable {
      height: 100% !important;
      min-height: unset !important;
    }

    .note-editing-area:focus-within {
      outline: none !important;
    }

    .note-editable:focus {
      outline: none !important;
    }

    .note-editor .note-editing-area .note-editable {
      outline: none !important;
      border: none !important;
    }

    .note-editor *:focus,
    .note-editor *:focus-within,
    .note-editor .note-editable,
    .note-editor .note-editing-area,
    .note-frame *,
    .note-frame *:focus,
    .note-frame *:focus-within {
      outline: none !important;
      border-color: transparent !important;
    }

    .note-placeholder,
    .note-editable {
      border: none !important;
      box-shadow: none !important;
    }

    .note-editor .note-dropzone {
      display: none !important;
    }

    @keyframes steam {
      0% {
        transform: translateY(0) translateX(-50%) scale(1);
        opacity: 0;
      }

      50% {
        transform: translateY(-10px) translateX(-40%) scale(1.2);
        opacity: 0.5;
      }

      100% {
        transform: translateY(-20px) translateX(-30%) scale(1.4);
        opacity: 0;
      }
    }

    @keyframes wiggle {

      0%,
      100% {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(-8deg);
      }

      75% {
        transform: rotate(8deg);
      }
    }

    #coffeeBtn {
      position: relative;
    }

    #coffeeBtn button {
      transition: transform 0.3s ease;
    }

    #coffeeBtn button:hover {
      animation: wiggle 0.5s ease-in-out;
    }

    #coffeeBtn button::before {
      content: "~";
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      opacity: 0;
      color: var(--text-color);
    }

    #coffeeBtn button:hover::before {
      animation: steam 1s ease-in-out infinite;
    }

    #coffeeBtn button i {
      transition: transform 0.3s ease;
    }

    #coffeeBtn:hover button i {
      transform: rotate(-15deg);
    }

    .hide-back-button .introjs-prevbutton {
      display: none !important;
    }

    .hide-back-button .introjs-tooltipbuttons {
      text-align: right;
    }

    .welcome-step.introjs-tooltip {
      max-width: 500px !important;
      width: 90% !important;
    }

    .welcome-step .introjs-tooltiptext {
      padding: 20px !important;
      line-height: 1.6 !important;
      font-size: 1.1em !important;
    }

    .welcome-step .introjs-tooltip-title {
      font-size: 1.4em !important;
      padding: 20px 20px 0 20px !important;
    }

    .welcome-step .introjs-tooltipbuttons {
      padding: 20px !important;
    }

    .introjs-tooltip.welcome-step {
      max-width: 600px !important;
      width: 90% !important;
      min-width: 500px !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltiptext {
      padding: 24px !important;
      line-height: 1.6 !important;
      font-size: 1.1em !important;
      text-align: left !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltip-title {
      font-size: 1.5em !important;
      padding: 24px 24px 0 24px !important;
      margin-bottom: 12px !important;
    }

    .welcome-step.introjs-tooltip .introjs-tooltipbuttons {
      padding: 20px !important;
      border-top: 1px solid var(--border-color) !important;
    }

    .welcome-step.introjs-tooltip {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
    }

    @media (max-width: 600px) {
      .welcome-step.introjs-tooltip {
        min-width: unset !important;
        width: calc(100% - 40px) !important;
        margin: 0 20px !important;
      }
    }

    .introjs-tooltip.welcome-step {
      max-width: 600px !important;
      width: 90% !important;
      min-width: 500px !important;
      position: fixed !important;
      left: 50% !important;
      top: 50% !important;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .welcome-step .introjs-arrow {
      display: none !important;
    }

    .welcome-step.introjs-tooltip:after,
    .welcome-step.introjs-tooltip:before {
      display: none !important;
    }

    .welcome-step .introjs-tooltiptext {
      text-align: center !important;
    }

    @media (max-width: 600px) {
      .introjs-tooltip.welcome-step {
        min-width: unset !important;
        width: calc(100% - 40px) !important;
        max-width: none !important;
      }
    }

    .github-link {
      color: var(--text-color);
      opacity: 0.7;
      margin-left: 5px;
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    .github-link:hover {
      opacity: 1;
    }

    .github-link i {
      font-size: 1.2em;
      vertical-align: middle;
    }

    .settings-dropdown {
      position: relative;
      display: inline-block;
    }

    .settings-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: var(--card-bg);
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      padding: 8px;
    }

    .settings-dropdown.active .settings-content {
      display: block;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
    }

    .settings-item:hover {
      background-color: var(--item-bg);
    }

    .settings-item span {
      color: var(--text-color);
    }

    .settings-item button {
      padding: 5px 10px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .settings-item button:hover {
      background-color: #000;
    }

    [data-theme="dark"] .settings-item button:hover {
      background-color: #666;
    }

    .backup-location-item {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 8px;
    }

    .backup-location-container {
      display: flex;
      width: 100%;
      justify-content: space-between;
      align-items: center;
    }

    .backup-path {
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.8;
      word-break: break-all;
      max-width: 150px;
    }

    .truncated-text,
    .full-text {
      display: inline;
    }

    .history-table td {
      word-break: break-word;
      line-height: 1.4;
      vertical-align: top;
      padding: 12px 8px;
    }

    .history-table .read-more-btn {
      background: none;
      border: none;
      color: #0066cc;
      cursor: pointer;
      padding: 2px 5px;
      font-size: 0.9em;
      margin-left: 5px;
    }

    .history-table .read-more-btn:hover {
      text-decoration: underline;
    }

    .introjs-tooltip {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .introjs-button {
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 4px;
      text-shadow: none;
      padding: 6px 12px;
    }

    .introjs-button:hover {
      background-color: #000;
      color: white;
    }

    [data-theme="dark"] .introjs-button:hover {
      background-color: #666;
    }

    .introjs-skipbutton {
      color: var(--text-color);
    }

    .introjs-progress {
      background-color: var(--border-color);
    }

    .introjs-progressbar {
      background-color: #555555;
    }

    .introjs-overlay {
      backdrop-filter: blur(10px);
      background-color: rgba(0, 0, 0, 0.5);
    }

    .introjs-helperLayer {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(0);
    }

    .introjs-helperLayer::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border-radius: 12px;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.3));
      z-index: -1;
    }

    .introjs-tooltiptext {
      color: var(--text-color);
    }

    .introjs-tooltip-title {
      color: var(--text-color);
      font-weight: bold;
    }

    .hidden-if-no-project {
      opacity: 0.5;
      pointer-events: none;
    }

    .hidden-if-no-list {
      opacity: 0.5;
      pointer-events: none;
    }

    .hidden-if-no-item {
      opacity: 0.5;
      pointer-events: none;
    }

    .introjs-helperLayer,
    .introjs-overlay {
      transition: all 0.3s ease-out !important;
    }

    .introjs-tooltip {
      z-index: 999999;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .hide-back-button .introjs-prevbutton {
      display: none !important;
    }

    .hide-back-button .introjs-tooltipbuttons {
      text-align: right;
    }

    .locale-selector {
      position: relative;
      width: 100%;
      margin-top: 5px;
    }

    .locale-selector input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 14px;
    }

    .locale-selector input:focus {
      outline: none;
      border-color: #555555;
    }

    .settings-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .settings-item span {
      margin-bottom: 5px;
      font-weight: 500;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
    }

    .toggle-switch-modern {
      position: relative;
      width: 50px;
      height: 24px;
      margin: 0;
    }

    .toggle-switch-checkbox {
      display: none;
    }

    .toggle-switch-label {
      display: block;
      overflow: hidden;
      cursor: pointer;
      border: 0 solid #bbb;
      border-radius: 24px;
      margin: 0;
    }

    .toggle-switch-label:before {
      content: "";
      display: block;
      width: 16px;
      height: 16px;
      margin: 4px;
      background: #FFFFFF;
      position: absolute;
      top: 0;
      bottom: 0;
      right: 26px;
      border-radius: 50%;
      transition: all .3s ease;
    }

    .toggle-switch-checkbox:checked + .toggle-switch-label {
      background-color: #555555;
    }

    .toggle-switch-checkbox:checked + .toggle-switch-label:before {
      right: 4px;
    }

    .toggle-switch-label {
      background-color: #555555;
      transition: all .3s ease;
    }

    .theme-toggle i {
      color: var(--text-color);
      font-size: 14px;
    }

    .due-date-calendar {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card-bg);
      border-radius: 6px;
      padding: 2px;
      font-size: 0.85em;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 45px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: display 0.2s ease;
    }

    .due-date-calendar .month {
      font-size: 0.7em;
      text-transform: uppercase;
      font-weight: bold;
      background: #555555;
      color: white;
      width: 100%;
      padding: 2px 0;
      letter-spacing: 0.5px;
    }

    .due-date-calendar .day {
      font-size: 1.2em;
      font-weight: bold;
      line-height: 1.4;
      padding: 2px 0;
      color: var(--text-color);
    }

    .list-item.overdue .due-date-calendar {
      border-color: #ff4444;
    }

    .list-item.overdue .due-date-calendar .month {
      background: #ff4444;
    }

    .list-item.overdue .due-date-calendar .day {
      color: #ff4444;
    }

    .list-item.due-soon .due-date-calendar {
      border-color: #ffd700;
    }

    .list-item.due-soon .due-date-calendar .month {
      background: #ffd700;
      color: #000;
    }

    .list-item.due-soon .due-date-calendar .day {
      color: #000;
    }


    .due-date-tag {
      position: absolute;
      top: 0;
      right: 0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8em;
      padding: 3px 6px;
      border-radius: 0 0 0 5px;
      background: var(--header-bg);
      white-space: nowrap;
      z-index: 2;
    }

    .list-item.overdue .due-date-tag {
      background: var(--header-bg);
      border-color: var(--border-color);
    }

    .list-item.due-soon .due-date-tag {
      background: var(--header-bg);
      border-color: var(--border-color);
    }

    .list-item.overdue .due-date-tag .month,
    .list-item.overdue .due-date-tag .day {
      color: #ff4444;
    }

    .list-item.due-soon .due-date-tag .month,
    .list-item.due-soon .due-date-tag .day {
      color: #ffd700;
    }

    [data-theme="dark"] .due-date-tag {
      background: var(--header-bg);
    }


    .due-date-tag .month {
      font-weight: 700;
      color: var(--text-color);
      opacity: 0.7;
    }

    .due-date-tag .day {
      font-weight: 700;
      color: var(--text-color);
    }

    .project-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }

    .project-tag {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      white-space: nowrap;
      opacity: 0.9;
    }

    .tags-container {
      margin: 15px 0;
    }

    .tags-input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .tags-input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .tag-color-picker {
      padding: 8px !important;
      width: 40px !important;
      height: 40px !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 4px !important;
      background-color: var(--card-bg) !important;
      cursor: pointer !important;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }

    .project-header-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 200px;
    }

    .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: transform 0.2s ease;
      background-color: #f4a261;
      display: inline-block;
    }

    .color-preview:hover {
      transform: scale(1.1);
    }

    .tag-color-picker {
      display: none !important;
    }

    .coloris-wrapper {
      display: none !important;
    }

    .clr-field {
      display: none !important;
    }

    .clr-picker {
      z-index: 2000 !important;
    }

    .list-item:hover .due-date-tag {
      display: none;
    }

    .list-item.due-soon::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ffd700;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
      z-index: 2;
    }

    .list-item.overdue::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      width: 12px;
      height: 12px;
      background-color: #ff4444;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 68, 68, 0.8);
      z-index: 2;
    }

    .introjs-tooltip {
      background-color: var(--card-bg) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color) !important;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2) !important;
    }

    .introjs-tooltiptext, 
    .introjs-tooltip-title, 
    .introjs-skipbutton {
      color: var(--text-color) !important;
    }

    .introjs-button {
      color: white !important;
      background-color: #555555 !important;
      border: none !important;
      text-shadow: none !important;
      border-radius: 4px !important;
    }

    .introjs-button:hover {
      background-color: #000000 !important;
      color: white !important;
    }

    [data-theme="dark"] .introjs-button:hover {
      background-color: #666666 !important;
    }

    .introjs-helperLayer {
      background-color: transparent !important;
      border: 1px solid var(--border-color) !important;
    }

    .introjs-overlay {
      background-color: rgba(0, 0, 0, 0.5) !important;
    }

    [data-theme="dark"] .introjs-overlay {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    .introjs-arrow.top-right,
    .introjs-arrow.top-middle,
    .introjs-arrow.top {
      border-bottom-color: var(--card-bg) !important;
    }

    .introjs-arrow.right,
    .introjs-arrow.right-middle {
      border-left-color: var(--card-bg) !important;
    }

    .introjs-arrow.bottom,
    .introjs-arrow.bottom-middle,
    .introjs-arrow.bottom-right {
      border-top-color: var(--card-bg) !important;
    }

    .introjs-arrow.left,
    .introjs-arrow.left-middle {
      border-right-color: var(--card-bg) !important;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="top-menu">
      <div class="logo">
        <h1>TasKan</h1>
        <span class="tagline">Organize. Track. Achieve.</span>
      </div>
      <div class="top-menu-buttons">
        <button id="addProjectBtn" title="Create New Project">
          New Project
        </button>
        <button id="importDataBtn" title="Import Data"><i class="fa-solid fa-file-import"></i></button>
        <button id="autoBackupBtn" title="Setup Auto-backup"><i class="fa-solid fa-file-export"></i></button>
        <button id="historyBtn" title="View Task History"><i class="fa fa-history"></i></button>
        <button id="themeToggleBtn" title="Toggle Theme">
          <i class="fas fa-moon"></i>
        </button>
        <a href="https://buymeacoffee.com/itcon" target="_blank" id="coffeeBtn">
          <button title="Buy me a coffee">
            <i class="fas fa-mug-hot"></i>
          </button>
        </a>
      </div>
    </div>
    <div id="projectsContainer" class="projects-container"></div>
    <div class="footer">
      
      <script>
        document.write(new Date().getFullYear());
      </script>
      ITCON  Made with <span class="heart"></span> in Melbourne, AU. Submit feature requests, issues at <a
        href="https://github.com/itcon-pty-au/taskan" target="_blank" class="github-link" title="View on GitHub">
        <i class="fab fa-github"></i>
      </a>
    </div>
  </div>

  <div class="editor-overlay"></div>
  <div class="editor-popup">
    <div class="editor-header">
      <h3>Edit Note</h3>
      <button class="close-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="due-date-container" style="display: none;">
      <label>Due Date:</label>
      <input type="date" id="dueDateInput">
      <button id="clearDueDate" title="Clear Due Date">
        <i class="fas fa-times"></i>
      </button>
      <span class="due-date-info"></span>
    </div>
    <div id="summernote"></div>
  </div>

  <div class="history-overlay"></div>
  <div class="history-modal">
    <div class="history-modal-header">
      <h3>Task History</h3>
      <div>
        <button class="cleanup-btn" title="Clear All History">
          <i class="fas fa-trash"></i> Clear History
        </button>
        <button class="close-btn"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <input type="text" class="history-search" placeholder="Search tasks..." />
    <table class="history-table">
      <thead>
        <tr>
          <th>Task</th>
          <th>Started At</th>
          <th>Completed At</th>
          <th>Time Taken</th>
          <th style="width: 50px">Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="form-overlay" style="display: none"></div>
  <div class="project-form" style="display: none">
    <div class="project-form-header">
      <h2>New Project</h2>
      <div class="form-buttons">
        <button class="submit-btn" title="Save Project">
          <i class="fa-solid fa-save"></i>
        </button>
        <button class="cancel-btn" title="Cancel">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>
    <div>
      <input type="text" id="projectName" placeholder="Enter project name" />
    </div>

    <div class="tags-container">
      <h3>Tags</h3>
      <div class="tags-input-container">
        <input type="text" class="tags-input" placeholder="Enter tags (comma separated)" />
        <div class="color-preview" title="Choose tag color" style="background-color: #f4a261;"></div>
        <input type="text" class="tag-color-picker" data-coloris value="#f4a261" style="display: none;" />
      </div>
    </div>

    <div class="milestones-container">
      <h3>
        Milestones
        <button class="add-milestone-btn" title="Add Milestone">
          <i class="fa-solid fa-plus"></i>
        </button>
      </h3>
      <div id="milestoneEntries"></div>
    </div>
  </div>

  <script>
    const AUTO_BACKUP_KEY = "kanbanAutoBackupHandle";
    const BACKUP_INTERVAL = 1000 * 60 * 60;
    const LAST_BACKUP_KEY = "kanbanLastBackupTime";

    const projectsContainer = document.getElementById("projectsContainer");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const importDataBtn = document.getElementById("importDataBtn");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const historyBtn = document.getElementById("historyBtn");

    let appData = (() => {
      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      const data = JSON.parse(localStorage.getItem("kanbanData")) || [];

      if (backupConfig) {
        localStorage.setItem(AUTO_BACKUP_KEY, backupConfig);
      }
      if (lastBackupTime) {
        localStorage.setItem(LAST_BACKUP_KEY, lastBackupTime);
      }

      return data;
    })();

    function saveData() {
      const backupConfig = localStorage.getItem(AUTO_BACKUP_KEY);
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      localStorage.setItem("kanbanData", JSON.stringify(appData));

      if (backupConfig) {
        localStorage.setItem(AUTO_BACKUP_KEY, backupConfig);
      }
      if (lastBackupTime) {
        localStorage.setItem(LAST_BACKUP_KEY, lastBackupTime);
      }
    }

    let currentTheme = localStorage.getItem("theme") || "dark";
    let taskHistory = JSON.parse(localStorage.getItem("taskHistory")) || [];
    let activeTimers = new Map();

    function createEditableElement(tag, value, onChange) {
      const el = document.createElement(tag);
      el.classList.add("editable");
      el.innerHTML = value ? formatTextWithLinks(value) : "";

      el.contentEditable = false;

      el.addEventListener("dblclick", () => {
        makeEditable(el);
      });

      function makeEditable(element) {
        element.contentEditable = true;
        element.textContent = element.textContent || "";
        element.focus();

        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(element);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      el.addEventListener("blur", () => {
        el.contentEditable = false;
        let newValue = el.textContent.trim();

        if (!newValue) {
          newValue = "Untitled";
        }

        onChange(newValue);
        el.innerHTML = formatTextWithLinks(newValue);
      });

      if (!value) {
        setTimeout(() => {
          makeEditable(el);
        }, 0);
      }

      el.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          if (event.shiftKey) {
            event.preventDefault();
            document.execCommand("insertLineBreak");
          } else {
            event.preventDefault();
            el.blur();
          }
        }
      });

      return el;
    }

    function createDeleteButton(deleteAction) {
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteButton.title = "Delete";

      let confirmTimeout;
      let isConfirming = false;

      deleteButton.addEventListener("click", () => {
        if (isConfirming) {
          clearTimeout(confirmTimeout);
          deleteAction();
        } else {
          isConfirming = true;
          deleteButton.innerHTML = "Sure?";
          deleteButton.title = "Click again to confirm deletion";
          deleteButton.classList.add("delete-confirm");

          confirmTimeout = setTimeout(() => {
            isConfirming = false;
            deleteButton.innerHTML =
              '<i class="fa-regular fa-trash-can"></i>';
            deleteButton.title = "Delete";
            deleteButton.classList.remove("delete-confirm");
          }, 5000);
        }
      });

      return deleteButton;
    }

    function createProject(project, projectElement = document.createElement("div")) {
      projectElement.className = "project";
      projectElement.id = `project-${project.id}`;

      const header = document.createElement("div");
      header.className = "project-header";

      const headerContent = document.createElement("div");
      headerContent.className = "project-header-content";

      const projectName = createEditableElement("div", project.name, (newName) => {
        project.name = newName;
        saveData();
      });

      headerContent.appendChild(projectName);

      if (project.tags && project.tags.length > 0) {
        const tagsContainer = document.createElement("div");
        tagsContainer.className = "project-tags";
        
        project.tags.forEach(tag => {
          const tagElement = document.createElement("span");
          tagElement.className = "project-tag";
          tagElement.textContent = tag;
          tagElement.style.backgroundColor = project.tagColor || "#555555";
          tagElement.style.color = getContrastColor(project.tagColor || "#555555");
          tagsContainer.appendChild(tagElement);
        });
        
        headerContent.appendChild(tagsContainer);
      }

      header.appendChild(headerContent);

      const buttonContainer = document.createElement("div");
      buttonContainer.style.display = "flex";
      buttonContainer.style.gap = "5px";
      const editButton = document.createElement("button");
      editButton.innerHTML = '<i class="fas fa-pen"></i>';
      editButton.title = "Edit Project";
      editButton.onclick = () => {
        const item = {
          id: Date.now(),
          type: "project",
          content: project.name,
          isNew: false
        };
        showProjectForm(project);
      };

      const addListButton = document.createElement("button");
      addListButton.className = "add-list-btn";
      addListButton.innerHTML = '<i class="fas fa-plus"></i>';
      addListButton.title = "Add List";
      addListButton.onclick = () => {
        const newList = { id: Date.now(), name: "", items: [] };
        project.lists.push(newList);
        saveData();
        renderSingleProject(project);
      };

      const collapseBtn = document.createElement("button");
      collapseBtn.innerHTML = project.collapsed ?
        '<i class="fas fa-chevron-down"></i>' :
        '<i class="fas fa-chevron-up"></i>';
      collapseBtn.title = project.collapsed ? "Expand" : "Collapse";
      collapseBtn.onclick = () => {
        project.collapsed = !project.collapsed;
        saveData();
        renderSingleProject(project);
      };

      const moveUpBtn = document.createElement("button");
      moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      moveUpBtn.title = "Move Project Up";
      moveUpBtn.disabled = appData.indexOf(project) === 0;
      moveUpBtn.onclick = () => {
        const index = appData.indexOf(project);
        if (index > 0) {
          [appData[index], appData[index - 1]] = [appData[index - 1], appData[index]];
          saveData();
          renderProjects();
        }
      };

      const moveDownBtn = document.createElement("button");
      moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
      moveDownBtn.title = "Move Project Down";
      moveDownBtn.disabled = appData.indexOf(project) === appData.length - 1;
      moveDownBtn.onclick = () => {
        const index = appData.indexOf(project);
        if (index < appData.length - 1) {
          [appData[index], appData[index + 1]] = [appData[index + 1], appData[index]];
          saveData();
          renderProjects();
        }
      };

      const deleteButton = createDeleteButton(() => {
        const index = appData.indexOf(project);
        if (index > -1) {
          appData.splice(index, 1);
          saveData();
          renderProjects();
        }
      });

      buttonContainer.appendChild(editButton);
      buttonContainer.appendChild(addListButton);
      buttonContainer.appendChild(collapseBtn);
      buttonContainer.appendChild(moveUpBtn);
      buttonContainer.appendChild(moveDownBtn);
      buttonContainer.appendChild(deleteButton);

      header.appendChild(headerContent);
      header.appendChild(buttonContainer);
      projectElement.appendChild(header);

      const listsContainer = document.createElement("div");
      listsContainer.classList.add("lists-container");
      if (project.collapsed) listsContainer.style.display = "none";

      project.lists.forEach((list, index) =>
        createList(project, list, listsContainer, index, project.lists.length)
      );

      projectElement.appendChild(listsContainer);

      if (project.milestones && project.milestones.length > 0) {
        const timelineContainer = createTimeline(project);
        projectElement.insertBefore(timelineContainer, listsContainer);
      }

      if (!projectElement.parentNode) {
        projectsContainer.appendChild(projectElement);
      }

      return projectElement;
    }

    function createList(project, list, container, index, totalLists) {
      if (!list.id) {
        list.id = Date.now() + Math.random();
      }

      const listDiv = document.createElement("div");
      listDiv.classList.add("list");

      const header = document.createElement("div");
      header.classList.add("list-header");

      const rearrangeButtons = document.createElement("div");
      rearrangeButtons.classList.add("rearrange-buttons");

      const headerContent = document.createElement("div");
      headerContent.classList.add("list-header-content");

      const listNameEl = createEditableElement(
        "div",
        list.name,
        (newName) => {
          list.name = newName;
          saveData();
          if (!newName) {
            project.lists = project.lists.filter((l) => l.id !== list.id);
            saveData();
            renderSingleProject(project);
          }
        }
      );

      const addTodoButton = document.createElement("button");
      addTodoButton.innerHTML = '<i class="fa-regular fa-square-check"></i>';
      addTodoButton.title = "New Todo";
      addTodoButton.addEventListener("click", () => {
        openEditor({
          id: Date.now(),
          type: "todo",
          completed: false,
          isNew: true,
          list: list,
        });
      });

      const addNoteButton = document.createElement("button");
      addNoteButton.innerHTML = '<i class="fa-regular fa-note-sticky"></i>';
      addNoteButton.title = "New Note";
      addNoteButton.addEventListener("click", () => {
        openEditor({
          id: Date.now(),
          type: "note",
          isNew: true,
          list: list,
        });
      });

      const addSubListButton = document.createElement("button");
      addSubListButton.innerHTML = '<i class="fas fa-layer-group"></i>';
      addSubListButton.title = "Add Sub-list";
      addSubListButton.addEventListener("click", () => {
        const newSubList = {
          id: Date.now(),
          name: "",
          items: [],
          isSubList: true,
          parentListId: list.id,
          isNew: true,
        };
        if (!list.subLists) list.subLists = [];
        list.subLists.push(newSubList);
        saveData();
        renderSingleProject(project);
      });

      const deleteListButton = createDeleteButton(() => {
        project.lists = project.lists.filter((l) => l.id !== list.id);
        saveData();
        renderSingleProject(project);
      });
      deleteListButton.title = "Delete List";

      if (index > 0) {
        const movePrevBtn = document.createElement("i");
        movePrevBtn.className = "fas fa-chevron-left";
        movePrevBtn.style.cursor = "pointer";
        movePrevBtn.title = "Move List Left";
        movePrevBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          const projectIndex = appData.findIndex(p => p.id === project.id);
          if (projectIndex !== -1) {
            [appData[projectIndex].lists[index - 1], appData[projectIndex].lists[index]] = [
              appData[projectIndex].lists[index],
              appData[projectIndex].lists[index - 1],
            ];
            saveData();
            renderSingleProject(appData[projectIndex]);
          }
        });
        rearrangeButtons.appendChild(movePrevBtn);
      }

      if (index < totalLists - 1) {
        const moveNextBtn = document.createElement("i");
        moveNextBtn.className = "fas fa-chevron-right";
        moveNextBtn.style.cursor = "pointer";
        moveNextBtn.title = "Move List Right";
        moveNextBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          const projectIndex = appData.findIndex(p => p.id === project.id);
          if (projectIndex !== -1) {
            [appData[projectIndex].lists[index + 1], appData[projectIndex].lists[index]] = [
              appData[projectIndex].lists[index],
              appData[projectIndex].lists[index + 1],
            ];
            saveData();
            renderSingleProject(appData[projectIndex]);
          }
        });
        rearrangeButtons.appendChild(moveNextBtn);
      }

      header.appendChild(rearrangeButtons);
      headerContent.appendChild(listNameEl);
      header.appendChild(headerContent);

      const buttonContainer = document.createElement("div");
      buttonContainer.style.display = "flex";
      buttonContainer.style.gap = "5px";

      buttonContainer.appendChild(addTodoButton);
      buttonContainer.appendChild(addNoteButton);
      buttonContainer.appendChild(addSubListButton);
      buttonContainer.appendChild(deleteListButton);
      headerContent.appendChild(buttonContainer);

      const listItemsContainer = document.createElement("div");
      listItemsContainer.classList.add("list-items");

      listItemsContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingItem = document.querySelector(".dragging");
        if (!draggingItem) return;

        const items = Array.from(listItemsContainer.children);
        const lastItem = items[items.length - 1];

        if (
          !items.length ||
          (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom)
        ) {
          removePlaceholders();
          const placeholder = createPlaceholder();
          listItemsContainer.appendChild(placeholder);
        }
      });

      listItemsContainer.addEventListener("dragleave", () => {
        listItemsContainer.classList.remove("drop-highlight");
      });

      listItemsContainer.addEventListener("drop", (e) => {
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData("text/plain"));

          if (data.type === "sublist") {
            const { subListId, parentListId, sourceListId } = data;
            const sourceList = appData
              .flatMap((p) => p.lists)
              .find((l) => l.id === sourceListId);

            if (!sourceList) return;
            if (!sourceList.subLists) sourceList.subLists = [];

            const draggedSubList = sourceList.subLists.find(
              (sl) => sl.id === subListId
            );
            if (!draggedSubList) return;

            sourceList.subLists = sourceList.subLists.filter(
              (sl) => sl.id !== subListId
            );

            if (!list.subLists) {
              list.subLists = [];
            }

            const placeholder =
              listItemsContainer.querySelector(".drop-placeholder");
            if (placeholder) {
              const items = Array.from(listItemsContainer.children);
              const placeholderIndex = items.indexOf(placeholder);
              const numItems = list.items.length;
              const subListIndex = Math.max(0, placeholderIndex - numItems);
              list.subLists.splice(subListIndex, 0, draggedSubList);
            } else {
              list.subLists.push(draggedSubList);
            }
            draggedSubList.parentListId = list.id;
          } else {
            const { itemId, listId, isSubListItem, parentListId } = data;

            let sourceList;
            let sourceItems;

            if (isSubListItem) {
              const parentList = appData
                .flatMap((p) => p.lists)
                .find((l) => l.id === parentListId);

              if (parentList && parentList.subLists) {
                sourceList = parentList.subLists.find(
                  (sl) => sl.id === listId
                );
                if (sourceList) {
                  sourceItems = sourceList.items;
                }
              }
            } else {
              sourceList = appData
                .flatMap((p) => p.lists)
                .find((l) => l.id === listId);
              if (sourceList) {
                sourceItems = sourceList.items;
              }
            }

            if (!sourceItems) return;
            const draggedItem = sourceItems.find((i) => i.id === itemId);
            if (!draggedItem) return;

            sourceItems = sourceItems.filter((i) => i.id !== itemId);
            if (isSubListItem) {
              sourceList.items = sourceItems;
            } else {
              sourceList.items = sourceItems;
            }

            const placeholder =
              listItemsContainer.querySelector(".drop-placeholder");
            if (placeholder) {
              const items = Array.from(listItemsContainer.children);
              const placeholderIndex = items.indexOf(placeholder);

              list.items.splice(placeholderIndex, 0, draggedItem);
            } else {
              list.items.push(draggedItem);
            }
          }

          saveData();
          renderSingleProject(project);
        } catch (err) {
          console.error("Error during drag and drop:", err);
        }
      });

      if (!list.items) list.items = [];

      list.items.forEach((item) =>
        createListItem(list, item, listItemsContainer, project)
      );

      if (!list.subLists) {
        list.subLists = [];
      }

      if (list.subLists.length > 0) {
        list.subLists.forEach((subList) => {
          if (!subList) return;
          subList.isSubList = true;
          subList.parentListId = list.id;

          const subListDiv = document.createElement("div");
          subListDiv.classList.add("sub-list");
          subListDiv.setAttribute("draggable", "true");
          subListDiv.dataset.subListId = subList.id;

          const subListHeader = document.createElement("div");
          subListHeader.classList.add("sub-list-header");

          const subListTitle = createEditableElement(
            "div",
            subList.name,
            (newName) => {
              if (newName) {
                subList.name = newName;
                subList.isNew = false;
                saveData();
              } else if (subList.isNew || !subList.name) {
                list.subLists = list.subLists.filter(
                  (sl) => sl.id !== subList.id
                );
                saveData();
                renderSingleProject(project);
              } else {
                subListTitle.innerHTML = formatTextWithLinks(subList.name);
              }
            }
          );
          subListTitle.style.flexGrow = "1";

          if (subList.isNew || !subList.name) {
            setTimeout(() => {
              subListTitle.contentEditable = true;
              subListTitle.focus();
            }, 0);
          }

          const deleteSubListButton = createDeleteButton(() => {
            list.subLists = list.subLists.filter(
              (sl) => sl.id !== subList.id
            );
            saveData();
            renderSingleProject(project);
          });

          subListHeader.appendChild(subListTitle);
          subListHeader.appendChild(deleteSubListButton);
          subListDiv.appendChild(subListHeader);

          const subListItems = document.createElement("div");
          subListItems.classList.add("sub-list-items");

          if (!subList.items) {
            subList.items = [];
          }

          subList.items.forEach((item) => {
            if (!item) return;
            item.parentListId = list.id;
            createListItem(subList, item, subListItems, project);
          });

          subListItems.addEventListener("dragover", (e) => {
            e.preventDefault();
            const draggingItem = document.querySelector(".dragging");
            if (!draggingItem) return;

            removePlaceholders();
            const placeholder = createPlaceholder();
            subListItems.appendChild(placeholder);
          });

          subListItems.addEventListener("drop", (e) => {
            e.preventDefault();
            try {
              const data = JSON.parse(e.dataTransfer.getData("text/plain"));

              if (data.type === "sublist") {
                const { subListId, parentListId, sourceListId } = data;
                const sourceList = appData
                  .flatMap((p) => p.lists)
                  .find((l) => l.id === sourceListId);
                const draggedSubList = sourceList.subLists.find(
                  (sl) => sl.id === subListId
                );

                if (!draggedSubList || draggedSubList.id === subList.id)
                  return;

                sourceList.subLists = sourceList.subLists.filter(
                  (sl) => sl.id !== subListId
                );

                const placeholder =
                  subListItems.querySelector(".drop-placeholder");
                if (placeholder) {
                  const items = Array.from(subListItems.children);
                  const placeholderIndex = items.indexOf(placeholder);

                  subList.items.splice(placeholderIndex, 0, draggedSubList);
                } else {
                  subList.items.push(draggedSubList);
                }
                draggedSubList.parentListId = list.id;
              } else {
                const { itemId, listId, isSubListItem, parentListId } = data;

                let sourceList;
                let sourceItems;

                if (isSubListItem) {
                  const parentList = appData
                    .flatMap((p) => p.lists)
                    .find((l) => l.id === parentListId);

                  if (parentList && parentList.subLists) {
                    sourceList = parentList.subLists.find(
                      (sl) => sl.id === listId
                    );
                    if (sourceList) {
                      sourceItems = sourceList.items;
                    }
                  }
                } else {
                  sourceList = appData
                    .flatMap((p) => p.lists)
                    .find((l) => l.id === listId);
                  if (sourceList) {
                    sourceItems = sourceList.items;
                  }
                }

                if (!sourceItems) return;
                const draggedItem = sourceItems.find((i) => i.id === itemId);
                if (!draggedItem) return;

                sourceItems = sourceItems.filter((i) => i.id !== itemId);
                if (isSubListItem) {
                  sourceList.items = sourceItems;
                } else {
                  sourceList.items = sourceItems;
                }

                const placeholder =
                  subListItems.querySelector(".drop-placeholder");
                if (placeholder) {
                  const items = Array.from(subListItems.children);
                  const placeholderIndex = items.indexOf(placeholder);

                  subList.items.splice(placeholderIndex, 0, draggedItem);
                } else {
                  subList.items.push(draggedItem);
                }
              }

              saveData();
              renderSingleProject(project);
            } catch (err) {
              console.error("Error during drag and drop:", err);
            }
          });

          subListDiv.addEventListener("dragstart", (e) => {
            e.stopPropagation();
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData(
              "text/plain",
              JSON.stringify({
                subListId: subList.id,
                parentListId: list.id,
                type: "sublist",
                sourceListId: list.id,
              })
            );
            subListDiv.classList.add("dragging");
            removePlaceholders();
          });

          subListDiv.addEventListener("dragend", () => {
            subListDiv.classList.remove("dragging");
            removePlaceholders();
          });

          subListDiv.appendChild(subListItems);
          listItemsContainer.appendChild(subListDiv);
        });
      }

      listDiv.appendChild(header);
      listDiv.appendChild(listItemsContainer);
      container.appendChild(listDiv);
    }

    function createListItem(list, item, container, project) {
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list-item");
      itemDiv.setAttribute("draggable", "true");
      itemDiv.setAttribute("data-item-id", item.id);

      const itemContent = document.createElement("div");
      if (item.type === "todo") {
        itemDiv.classList.add("todo-item");
        itemContent.classList.add("item-name");
        if (item.completed) {
          itemContent.classList.add("strikethrough");
        }
      }

      if (item.backgroundColor) {
        itemDiv.style.backgroundColor = item.backgroundColor;
      }

      if (item.type === "todo" && item.dueDate) {
        const dueDate = new Date(item.dueDate);
        const localDueDate = new Date(dueDate.getUTCFullYear(), dueDate.getUTCMonth(), dueDate.getUTCDate());
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        const diffTime = localDueDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffTime < 0) {
          itemDiv.classList.add("overdue");
        } else if (diffDays <= 2) {
          itemDiv.classList.add("due-soon");
        }

        const calendarTag = document.createElement("span");
        calendarTag.classList.add("due-date-tag");
        
        const month = localDueDate.toLocaleString('default', { month: 'short' }).toUpperCase();
        const day = localDueDate.getDate();
        
        calendarTag.innerHTML = `
          <span class="month">${month}</span>
          <span class="day">${day}</span>
        `;
        
        itemDiv.appendChild(calendarTag);
      }

      const hoverMenu = document.createElement("div");
      hoverMenu.classList.add("item-hover-menu");

      const editorBtn = document.createElement("button");
      editorBtn.innerHTML = '<i class="fas fa-pen-to-square"></i>';
      editorBtn.title = "Open Editor";
      editorBtn.addEventListener("click", () => openEditor(item));

      const toggleTypeBtn = document.createElement("button");
      toggleTypeBtn.innerHTML = '<i class="fa-solid fa-shuffle"></i>';
      toggleTypeBtn.title = item.type === "todo" ? "Convert to Note" : "Convert to Todo";
      toggleTypeBtn.addEventListener("click", () => {
        if (item.type === "todo") {
          item.type = "note";
          delete item.completed;
        } else {
          item.type = "todo";
          item.completed = false;
        }
        saveData();
        renderSingleProject(project);
      });

      const colorInput = document.createElement("input");
      colorInput.type = "text";
      colorInput.setAttribute("data-coloris", "");
      colorInput.style.display = "none";

      const colorPickerBtn = document.createElement("button");
      colorPickerBtn.innerHTML = '<i class="fas fa-fill-drip"></i>';
      colorPickerBtn.title = "Change Color";
      colorPickerBtn.addEventListener("click", () => {
        colorInput.click();
      });

      colorInput.addEventListener("change", (event) => {
        const color = event.target.value;
        item.backgroundColor = color;
        itemDiv.style.backgroundColor = color;
        saveData();
      });

      if (item.type === "todo") {
        const timerControls = document.createElement("div");
        timerControls.classList.add("time-tracker");

        const playPauseBtn = document.createElement("button");
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.title = "Start Timer";

        const timerDisplay = document.createElement("span");
        timerDisplay.classList.add("elapsed-time");
        timerDisplay.textContent = formatTime(item.elapsedTime || 0);

        playPauseBtn.addEventListener("click", () => {
          if (activeTimers.has(item.id)) {
            stopTimer(item);
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.title = "Start Timer";
          } else {
            startTimer(item, timerDisplay);
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.title = "Pause Timer";
          }
        });

        timerControls.appendChild(playPauseBtn);
        timerControls.appendChild(timerDisplay);
        hoverMenu.appendChild(timerControls);
      }

      const deleteButton = createDeleteButton(() => {
        list.items = list.items.filter((i) => i.id !== item.id);
        saveData();
        renderSingleProject(project);
      });

      hoverMenu.appendChild(editorBtn);
      hoverMenu.appendChild(toggleTypeBtn);
      hoverMenu.appendChild(colorPickerBtn);
      hoverMenu.appendChild(colorInput);
      hoverMenu.appendChild(deleteButton);

      itemDiv.appendChild(hoverMenu);

      if (item.type === "todo") {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.completed;
        checkbox.classList.add("todo-checkbox");
        checkbox.addEventListener("change", () => {
          item.completed = checkbox.checked;
          itemContent.classList.toggle("strikethrough", item.completed);
          if (item.completed) {
            stopTimer(item);
            addToHistory(item);
            item.completedAt = new Date().toISOString();
          } else {
            delete item.completedAt;
          }
          saveData();
        });

        itemDiv.appendChild(checkbox);
      }

      itemContent.innerHTML = formatTextWithLinks(
        stripHtml(item.content || item.name || "").substring(0, 100) +
        (stripHtml(item.content || item.name || "").length > 100 ? "..." : "")
      );

      itemContent.addEventListener("click", () => openEditor(item));
      itemContent.style.cursor = "pointer";

      itemDiv.appendChild(itemContent);
      container.appendChild(itemDiv);

      setupDragAndDrop(itemDiv, item, list, container, project);
    }

    function setupDragAndDrop(itemDiv, item, list, container, project) {
      itemDiv.addEventListener("dragstart", (e) => {
        e.stopPropagation();
        e.dataTransfer.effectAllowed = "move";
        const isSubListItem = list.isSubList || false;
        const parentListId = list.parentListId || list.id;
        e.dataTransfer.setData(
          "text/plain",
          JSON.stringify({
            itemId: item.id,
            listId: list.id,
            isSubListItem: isSubListItem,
            parentListId: parentListId,
            type: "item",
          })
        );
        itemDiv.classList.add("dragging");
        removePlaceholders();
      });

      itemDiv.addEventListener("dragend", (e) => {
        e.stopPropagation();
        itemDiv.classList.remove("dragging");
        removePlaceholders();
        document.querySelectorAll(".shift-up, .shift-down").forEach((el) => {
          el.classList.remove("shift-up", "shift-down");
        });
      });

      itemDiv.addEventListener("dragover", handleDragOver);
      itemDiv.addEventListener("dragleave", handleDragLeave);
      itemDiv.addEventListener("drop", (e) => handleDrop(e, list, container, project));
    }

    function formatDueDate(dueDate) {
      const now = new Date();
      const due = new Date(dueDate);
      const diffTime = due - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffTime < 0) {
        return "Overdue";
      } else if (diffDays === 0) {
        return "Due today";
      } else if (diffDays === 1) {
        return "Due tomorrow";
      } else {
        return `Due in ${diffDays} days`;
      }
    }

    function createPlaceholder() {
      const placeholder = document.createElement("div");
      placeholder.classList.add("drop-placeholder");
      return placeholder;
    }

    function removePlaceholders() {
      document
        .querySelectorAll(".drop-placeholder")
        .forEach((el) => el.remove());
    }

    function renderProjects() {
      projectsContainer.innerHTML = "";
      appData.forEach(project => {
        createProject(project);
      });

      Coloris({
        theme: "default",
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          "#264653",
          "#2a9d8f",
          "#e9c46a",
          "#f4a261",
          "#e76f51",
          "#ef476f",
          "#ffd166",
          "#06d6a0",
          "#118ab2",
          "#073b4c",
        ],
      });
    }

    addProjectBtn.addEventListener("click", () => showProjectForm(null));

    importDataBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";

      input.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                appData = importedData;
                saveData();
                renderProjects();

                const originalContent = importDataBtn.innerHTML;

                importDataBtn.innerHTML = " Imported";
                importDataBtn.style.backgroundColor = "#28a745";

                setTimeout(() => {
                  importDataBtn.innerHTML = '<i class="fa-solid fa-file-import"></i>';
                  importDataBtn.style.backgroundColor = "";
                }, 2000);
              } else {
                const originalContent = importDataBtn.innerHTML;

                importDataBtn.innerHTML = " Invalid Format";
                importDataBtn.style.backgroundColor = "#dc3545";

                setTimeout(() => {
                  importDataBtn.innerHTML = originalContent;
                  importDataBtn.style.backgroundColor = "";
                }, 2000);
              }
            } catch (error) {
              const originalContent = importDataBtn.innerHTML;

              importDataBtn.innerHTML = " Invalid File";
              importDataBtn.style.backgroundColor = "#dc3545";

              setTimeout(() => {
                importDataBtn.innerHTML = originalContent;
                importDataBtn.style.backgroundColor = "";
              }, 2000);
            }
          };
          reader.readAsText(file);
        }
      });

      input.click();
    });

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      currentTheme = theme;

      const themeToggleBtnInMenu = document.getElementById('themeToggleBtn');
      if (themeToggleBtnInMenu) {
        themeToggleBtnInMenu.innerHTML = theme === "dark"
          ? '<i class="fas fa-sun"></i>'
          : '<i class="fas fa-moon"></i>';
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      Coloris({
        theme: "default",
        themeMode: currentTheme,
        formatToggle: false,
        clearButton: true,
        alpha: false,
        wrap: true,
        closeButton: true,
        swatches: [
          "#264653",
          "#2a9d8f",
          "#e9c46a",
          "#f4a261",
          "#e76f51",
          "#ef476f",
          "#ffd166",
          "#06d6a0",
          "#118ab2",
          "#073b4c",
        ],
      });

      renderProjects();
    });

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    function openEditor(item) {
      const popup = document.querySelector(".editor-popup");
      const overlay = document.querySelector(".editor-overlay");
      const closeBtn = popup.querySelector(".close-btn");
      const dueDateContainer = popup.querySelector(".due-date-container");
      const dueDateInput = popup.querySelector("#dueDateInput");
      const clearDueDate = popup.querySelector("#clearDueDate");
      const dueDateInfo = popup.querySelector(".due-date-info");
      const headerTitle = popup.querySelector(".editor-header h3");

      $('#summernote').empty();
      if ($('#summernote').data('summernote')) {
        $('#summernote').summernote('destroy');
      }

      dueDateContainer.style.display = item.type === "todo" ? "flex" : "none";
      headerTitle.textContent = item.type === "todo" ? "Edit Todo" : "Edit Note";

      if (item.type === "todo" && item.dueDate) {
        dueDateInput.value = item.dueDate.slice(0, 10);
        updateDueDateInfo(item.dueDate);
      } else {
        dueDateInput.value = "";
        dueDateInfo.textContent = "";
      }

      $('#summernote').summernote({
        height: "100%",
        minHeight: null,
        maxHeight: null,
        placeholder: "Start typing...",
        focus: true,
        callbacks: {
          onInit: function () {
            if (!item.isNew) {
              $('#summernote').summernote('code', item.content || item.name || '');
            } else {
              $('#summernote').summernote('code', '');
            }

            if (item.isNew && item.type === "todo" && dueDateInput.value) {
              const date = new Date(dueDateInput.value + 'T00:00:00');
              item.dueDate = date.toISOString();
              updateDueDateInfo(item.dueDate);
            }

            setTimeout(() => {
              $('#summernote').summernote('focus');
              $('.note-editable').focus();
              
              const editableDiv = $('.note-editable')[0];
              const range = document.createRange();
              const sel = window.getSelection();
              
              range.setStart(editableDiv, 0);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
              
              $('.note-editor').css('display', 'flex');
              $('.note-editing-area').css('display', 'flex');
              $('#summernote').css('display', 'flex');
            }, 100);
          },
          onChange: function (contents) {
            item.content = contents;
            
            const project = appData.find(p =>
              p.lists.some(l =>
                l.items.some(i => i.id === item.id) ||
                (l.subLists && l.subLists.some(sl => sl.items.some(i => i.id === item.id)))
              )
            );
            
            if (project) {
              saveData();
              const itemElement = document.querySelector(`[data-item-id="${item.id}"] .item-name`);
              if (itemElement) {
                itemElement.innerHTML = formatTextWithLinks(
                  stripHtml(contents).substring(0, 100) +
                  (stripHtml(contents).length > 100 ? "..." : "")
                );
              }
            }
          }
        },
        spellCheck: true,
        disableGrammar: false,
        styleTags: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
        prettifyHtml: false,
        emptyPara: ''
      });

      popup.style.display = "flex";
      overlay.style.display = "block";

      dueDateInput.addEventListener("change", function () {
        if (this.value) {
          const selectedDate = this.value + 'T00:00:00Z';
          const date = new Date(selectedDate);
          item.dueDate = date.toISOString();
          updateDueDateInfo(item.dueDate);

          const project = appData.find(p =>
            p.lists.some(l =>
              l.items.some(i => i.id === item.id) ||
              (l.subLists && l.subLists.some(sl => sl.items.some(i => i.id === item.id)))
            )
          );

          if (project) {
            saveData();
            renderSingleProject(project);
          }
        }
        saveData();
      });

      clearDueDate.addEventListener("click", function () {
        dueDateInput.value = "";
        delete item.dueDate;
        dueDateInfo.textContent = "";

        const project = appData.find(p =>
          p.lists.some(l =>
            l.items.some(i => i.id === item.id) ||
            (l.subLists && l.subLists.some(sl => sl.items.some(i => i.id === item.id)))
          )
        );

        if (project) {
          saveData();
          renderSingleProject(project);
        }
      });

      const closeEditor = () => {
        const content = $('#summernote').summernote('code');
        const strippedContent = stripHtml(content).trim();

        if (item.isNew && strippedContent !== "") {
          const newItem = {
            id: item.id,
            name: strippedContent.substring(0, 50),
            type: item.type,
            content: content,
            completed: item.type === "todo" ? false : undefined,
          };

          if (item.dueDate) {
            newItem.dueDate = item.dueDate;
          }

          if (item.list) {
            item.list.items.push(newItem);
            saveData();
            const project = appData.find(p =>
              p.lists.some(l => l.id === item.list.id)
            );
            if (project) {
              renderSingleProject(project);
            }
          }
        }

        $('#summernote').empty();
        $('#summernote').summernote('destroy');
        popup.style.display = "none";
        overlay.style.display = "none";
      };

      closeBtn.onclick = closeEditor;
      overlay.onclick = closeEditor;
    }

    function updateDueDateInfo(dueDate) {
      const dueDateInfo = document.querySelector(".due-date-info");
      const now = new Date();
      const due = new Date(dueDate);
      const diffTime = due - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffTime < 0) {
        dueDateInfo.textContent = "Overdue";
        dueDateInfo.style.color = "#ff4444";
      } else if (diffDays === 0) {
        dueDateInfo.textContent = "Due today";
        dueDateInfo.style.color = "#ffd700";
      } else if (diffDays === 1) {
        dueDateInfo.textContent = "Due tomorrow";
        dueDateInfo.style.color = "#ffd700";
      } else {
        dueDateInfo.textContent = `Due in ${diffDays} days`;
        dueDateInfo.style.color = "";
      }
    }

    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, (url) => {
        const safeUrl = url
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
        return `<a href="${safeUrl}" class="item-link" target="_blank">${safeUrl}</a>`;
      });
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hrs.toString().padStart(2, "0")}:${mins
        .toString()
        .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    }

    function startTimer(item, timerDisplay) {
      if (activeTimers.has(item.id)) return;

      if (!item.startTime) {
        item.startTime = new Date().toISOString();
      }

      const startTime = Date.now() - (item.elapsedTime || 0) * 1000;
      const timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        item.elapsedTime = elapsed;
        timerDisplay.textContent = formatTime(elapsed);
        saveData();
      }, 1000);

      activeTimers.set(item.id, timer);
    }

    function stopTimer(item) {
      const timer = activeTimers.get(item.id);
      if (timer) {
        clearInterval(timer);
        activeTimers.delete(item.id);
      }
    }

    function addToHistory(item) {
      taskHistory.push({
        task: item.content || item.name,
        timeTaken: item.elapsedTime || 0,
        startedAt: item.startTime || new Date().toISOString(),
        completedAt: new Date().toISOString(),
      });
      localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString(navigator.language, {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      });
    }

    function renderHistory(tbody, filter = "") {
      const filteredHistory = taskHistory.filter((entry) =>
        stripHtml(entry.task).toLowerCase().includes(filter.toLowerCase())
      );

      if (filteredHistory.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; font-size: 1.1em; color: #666;">
              ${filter ? "No tasks found matching your search. Try something else?" : "No completed tasks yet. Time to get productive! "}
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = filteredHistory
          .map((entry, index) => {
            const plainText = stripHtml(entry.task);

            let taskDisplay;
            if (plainText.length > 100) {
              taskDisplay = `
                <span class="truncated-text" data-index="${index}">${plainText.substring(0, 100)}...</span>
                <span class="full-text" data-index="${index}" style="display: none;">${plainText}</span>
                <button class="read-more-btn" data-index="${index}">Read More</button>
              `;
            } else {
              taskDisplay = plainText;
            }

            return `
              <tr data-index="${index}">
                <td>${taskDisplay}</td>
                <td>${formatDate(entry.startedAt)}</td>
                <td>${formatDate(entry.completedAt)}</td>
                <td>${formatTime(entry.timeTaken)}</td>
                <td class="action-column">
                  <button class="delete-history-btn" title="Delete Entry">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");

        tbody.querySelectorAll(".read-more-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = this.getAttribute('data-index');
            const truncatedText = tbody.querySelector(`.truncated-text[data-index="${index}"]`);
            const fullText = tbody.querySelector(`.full-text[data-index="${index}"]`);

            if (truncatedText.style.display !== "none") {
              truncatedText.style.display = "none";
              fullText.style.display = "inline";
              this.textContent = "Show Less";
            } else {
              truncatedText.style.display = "inline";
              fullText.style.display = "none";
              this.textContent = "Read More";
            }
          });
        });

        tbody.querySelectorAll(".delete-history-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const row = this.closest("tr");
            const index = parseInt(row.dataset.index);
            taskHistory.splice(index, 1);
            localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
            renderHistory(tbody, document.querySelector(".history-search").value);
          });
        });
      }
    }

    function clearHistory() {
      if (
        confirm(
          "Are you sure you want to clear all task history? This cannot be undone."
        )
      ) {
        taskHistory = [];
        localStorage.setItem("taskHistory", JSON.stringify(taskHistory));
        const tbody = document.querySelector(".history-modal tbody");
        renderHistory(tbody);
      }
    }

    function showHistory() {
      const modal = document.querySelector(".history-modal");
      const overlay = document.querySelector(".history-overlay");
      const searchInput = modal.querySelector(".history-search");
      const tbody = modal.querySelector("tbody");
      const cleanupBtn = modal.querySelector(".cleanup-btn");

      searchInput.value = "";
      searchInput.addEventListener("input", (e) =>
        renderHistory(tbody, e.target.value)
      );
      cleanupBtn.addEventListener("click", clearHistory);
      renderHistory(tbody);

      modal.style.display = "block";
      overlay.style.display = "block";

      const closeModal = () => {
        modal.style.display = "none";
        overlay.style.display = "none";
      };

      modal.querySelector(".close-btn").onclick = closeModal;
      overlay.onclick = closeModal;
    }

    historyBtn.addEventListener("click", showHistory);

    function showProjectForm(projectToEdit = null) {
      const form = document.querySelector(".project-form");
      const overlay = document.querySelector(".form-overlay");
      const milestoneEntries = document.getElementById("milestoneEntries");
      const projectNameInput = document.getElementById("projectName");
      const tagsInput = form.querySelector(".tags-input");
      const tagColorPicker = form.querySelector(".tag-color-picker");
      const colorPreview = form.querySelector(".color-preview");
      const submitBtn = document.querySelector(".submit-btn");

      const newColorPreview = colorPreview.cloneNode(true);
      colorPreview.parentNode.replaceChild(newColorPreview, colorPreview);
      
      newColorPreview.addEventListener("click", () => {
        const rect = newColorPreview.getBoundingClientRect();
        const picker = document.querySelector('.clr-picker');
        if (picker) {
          requestAnimationFrame(() => {
            picker.style.position = 'fixed';
            picker.style.left = `${rect.left}px`;
            picker.style.top = `${rect.bottom + 5}px`;
            picker.style.margin = '0';
          });
        }
        tagColorPicker.click();
      });
      
      tagColorPicker.addEventListener("change", (e) => {
        newColorPreview.style.backgroundColor = e.target.value;
      });

      form.querySelector("h2").textContent = projectToEdit
        ? "Edit Project"
        : "New Project";
      submitBtn.title = projectToEdit ? "Save Changes" : "Create Project";

      projectNameInput.value = "";
      tagsInput.value = "";
      const defaultColor = "#f4a261";
      tagColorPicker.value = defaultColor;
      colorPreview.style.backgroundColor = defaultColor;
      milestoneEntries.innerHTML = "";

      if (projectToEdit) {
        projectNameInput.value = projectToEdit.name;
        if (projectToEdit.tags) {
          tagsInput.value = projectToEdit.tags.join(", ");
          const projectColor = projectToEdit.tagColor || defaultColor;
          tagColorPicker.value = projectColor;
          colorPreview.style.backgroundColor = projectColor;
        }

        if (projectToEdit.milestones) {
          projectToEdit.milestones.forEach((milestone) => {
            const entry = document.createElement("div");
            entry.classList.add("milestone-entry");

            entry.innerHTML = `
              <input type="text" class="milestone-name" placeholder="Milestone name" value="${milestone.name}">
              <input type="date" class="milestone-date" value="${milestone.date}">
              <span class="remove-milestone" title="Remove Milestone"></span>
            `;

            entry
              .querySelector(".remove-milestone")
              .addEventListener("click", () => {
                entry.remove();
              });

            milestoneEntries.appendChild(entry);
          });
        }
      }

      if (milestoneEntries.children.length === 0) {
        addMilestoneEntry();
      }

      form.style.display = "block";
      overlay.style.display = "block";

      submitBtn.onclick = () => {
        const projectName = projectNameInput.value.trim();
        if (!projectName) return;

        const tags = tagsInput.value
          .split(",")
          .map(tag => tag.trim())
          .filter(tag => tag.length > 0);
        const tagColor = tagColorPicker.value;

        const milestones = Array.from(
          document.querySelectorAll(".milestone-entry")
        )
          .map((entry) => ({
            name: entry.querySelector(".milestone-name").value.trim(),
            date: entry.querySelector(".milestone-date").value,
          }))
          .filter((m) => m.name && m.date);

        if (projectToEdit) {
          projectToEdit.name = projectName;
          projectToEdit.tags = tags.length > 0 ? tags : undefined;
          projectToEdit.tagColor = tagColor;
          projectToEdit.milestones =
            milestones.length > 0 ? milestones : undefined;
        } else {
          const newProject = {
            id: Date.now(),
            name: projectName,
            tags: tags.length > 0 ? tags : undefined,
            tagColor: tagColor,
            lists: [],
            milestones: milestones.length > 0 ? milestones : undefined,
          };
          appData.unshift(newProject);
        }

        saveData();
        renderProjects();

        form.style.display = "none";
        overlay.style.display = "none";
      };
    }

    function addMilestoneEntry() {
      const container = document.getElementById("milestoneEntries");
      const entry = document.createElement("div");
      entry.classList.add("milestone-entry");

      entry.innerHTML = `
        <input type="text" class="milestone-name" placeholder="Milestone name">
        <input type="date" class="milestone-date">
        <span class="remove-milestone" title="Remove Milestone"></span>
      `;

      entry
        .querySelector(".remove-milestone")
        .addEventListener("click", () => {
          entry.remove();
        });

      container.appendChild(entry);
    }

    function createTimeline(project) {
      if (!project.milestones || project.milestones.length === 0) return;

      const timelineContainer = document.createElement("div");
      timelineContainer.classList.add("timeline-container");

      const timelineDiv = document.createElement("div");
      timelineDiv.classList.add("timeline");
      timelineDiv.id = `timeline-${project.id}`;

      timelineContainer.appendChild(timelineDiv);

      timelineContainer.addEventListener("dblclick", () => {
        showProjectForm(project);
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.classList.add("timeline-delete-btn");
      deleteBtn.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
      deleteBtn.title = "Delete Timeline";

      let confirmTimeout;
      let isConfirming = false;

      deleteBtn.addEventListener("click", () => {
        if (isConfirming) {
          clearTimeout(confirmTimeout);
          delete project.milestones;
          saveData();
          renderSingleProject(project);
        } else {
          isConfirming = true;
          deleteBtn.innerHTML = "Sure?";
          deleteBtn.title = "Click again to confirm deletion";
          deleteBtn.classList.add("delete-confirm");

          confirmTimeout = setTimeout(() => {
            isConfirming = false;
            deleteBtn.innerHTML = '<i class="fa-regular fa-trash-can"></i>';
            deleteBtn.title = "Delete Timeline";
            deleteBtn.classList.remove("delete-confirm");
          }, 5000);
        }
      });

      timelineContainer.appendChild(deleteBtn);

      const formatDate = (date) => {
        return new Date(date).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      };

      const dates = project.milestones.map((m) => new Date(m.date));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      minDate.setDate(minDate.getDate() - 14);
      maxDate.setDate(maxDate.getDate() + 14);

      const items = new DataSet(
        project.milestones.map((milestone, index) => ({
          id: index,
          content: milestone.name,
          start: milestone.date,
          title: `${milestone.name}<br>${formatDate(milestone.date)}`,
        }))
      );

      const options = {
        height: "100px",
        min: minDate,
        max: maxDate,
        zoomable: false,
        margin: { item: 10 },
        orientation: { axis: "top" },
        selectable: false,
        showTooltips: true,
        stack: false,
        horizontalScroll: false,
        timeAxis: {
          scale: "week",
          step: 1,
        },
        align: "center",
        type: "point",
        template: function (item) {
          return `<div class="vis-item-content">${item.content}</div>`;
        },
        format: {
          minorLabels: {
            week: "",
            month: "MMM",
          },
          majorLabels: {
            month: "YYYY",
          },
        },
        snap: null,
        verticalScroll: false,
        showCurrentTime: true,
        showMajorLabels: true,
        showMinorLabels: true,
        width: "100%",
        autoResize: true,
        start: minDate,
        end: maxDate,
      };

      const timeline = new Timeline(timelineDiv, items, options);
      timeline.fit();

      return timelineContainer;
    }

    document
      .querySelector(".add-milestone-btn")
      .addEventListener("click", addMilestoneEntry);

    document.querySelector(".cancel-btn").addEventListener("click", () => {
      document.querySelector(".project-form").style.display = "none";
      document.querySelector(".form-overlay").style.display = "none";
    });

    async function setupAutoBackup() {
      try {
        const data = JSON.stringify(appData, null, 2);
        const now = new Date();
        const timestamp = now.getFullYear() +
          String(now.getMonth() + 1).padStart(2, "0") +
          String(now.getDate()).padStart(2, "0") +
          "T" +
          String(now.getHours()).padStart(2, "0") +
          String(now.getMinutes()).padStart(2, "0") +
          String(now.getSeconds()).padStart(2, "0");

        const filename = `kanban-backup-${timestamp}.json`;

        const autoBackupBtn = document.getElementById("autoBackupBtn");

        try {
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{
              description: 'JSON File',
              accept: { 'application/json': ['.json'] },
            }],
          });

          const writable = await fileHandle.createWritable();
          await writable.write(data);
          await writable.close();

          autoBackupBtn.innerHTML = " Exported";
          autoBackupBtn.style.backgroundColor = "#28a745";

          updateBackupStatus(now);

          setTimeout(() => {
            autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
            autoBackupBtn.style.backgroundColor = "";
          }, 2000);

        } catch (err) {
          if (err.name !== 'AbortError') {
            try {
              const blob = new Blob([data], { type: 'application/json' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              
              autoBackupBtn.innerHTML = " Exported";
              autoBackupBtn.style.backgroundColor = "#28a745";
              
              updateBackupStatus(now);

              setTimeout(() => {
                autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
                autoBackupBtn.style.backgroundColor = "";
              }, 2000);

            } catch (downloadErr) {
              autoBackupBtn.innerHTML = " Invalid File";
              autoBackupBtn.style.backgroundColor = "#dc3545";
              
              setTimeout(() => {
                autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
                autoBackupBtn.style.backgroundColor = "";
              }, 2000);
            }
          } else {
            autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
            autoBackupBtn.style.backgroundColor = "";
            return;
          }
        }
      } catch (err) {
        console.error('Error during backup:', err);
        const autoBackupBtn = document.getElementById("autoBackupBtn");
        autoBackupBtn.innerHTML = " Invalid File";
        autoBackupBtn.style.backgroundColor = "#dc3545";
        
        setTimeout(() => {
          autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
          autoBackupBtn.style.backgroundColor = "";
        }, 2000);
      }
    }

    function scheduleBackupReminder() {
      if (!window.backupReminderScheduled) {
        window.backupReminderScheduled = true;

        const autoBackupBtn = document.getElementById("autoBackupBtn");
        if (autoBackupBtn) {
          autoBackupBtn.classList.add("backup-nudge");
          autoBackupBtn.title = " Backup needed - Click to perform backup";
          autoBackupBtn.innerHTML = " Backup Needed";
        }
      }
    }

    let autoBackupInterval;

    function updateTopMenu() {
      const autoBackupBtn = document.getElementById("autoBackupBtn");
      if (autoBackupBtn) {
        autoBackupBtn.title = "Export Data";
        autoBackupBtn.addEventListener("click", setupAutoBackup);
      }
    }

    async function initializeApp() {
      console.log("Initializing app...");

      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      cleanupCompletedTodos();
      renderProjects();
      updateTopMenu();

      if (appData.length > 0) {
        const lastBackupDate = lastBackupTime
          ? new Date(lastBackupTime.replace(
            /(\d{2})\/(\d{2})\/(\d{4}), (\d{2}:\d{2}:\d{2})/,
            "$3-$2-$1T$4"
          ))
          : null;
        const now = new Date();

        if (!lastBackupDate || now.getTime() - lastBackupDate.getTime() > 60 * 60 * 1000) {
          nudgeBackup();
        } else {
          const timeUntilNextNudge = 60 * 60 * 1000 - (now.getTime() - lastBackupDate.getTime());
          setTimeout(nudgeBackup, timeUntilNextNudge);
        }
      }

      cleanupInvalidDates();
      initTutorial();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeApp);
    } else {
      initializeApp();
    }

    function cleanupInvalidDates() {
      const lastBackupStr = localStorage.getItem(LAST_BACKUP_KEY);
      if (!lastBackupStr) return;

      try {
        const [datePart, timePart] = lastBackupStr.split(", ");
        const [day, month, year] = datePart.split("/");
        const [hours, minutes, seconds] = timePart.split(":");

        const lastBackupDate = new Date(
          parseInt(year),
          parseInt(month) - 1,
          parseInt(day),
          parseInt(hours),
          parseInt(minutes),
          parseInt(seconds)
        );

        const now = new Date();

        now.setHours(now.getHours() + 1);

        if (isNaN(lastBackupDate.getTime()) || lastBackupDate > now) {
          console.log("Invalid backup date detected:", {
            lastBackupStr,
            parsed: lastBackupDate,
            now: now,
          });
          localStorage.removeItem(LAST_BACKUP_KEY);
        }
      } catch (err) {
        console.error("Error parsing backup date:", err);
      }
    }

    function checkStorageIntegrity() {
      console.log("Checking storage integrity...");
      const lastBackupTime = localStorage.getItem(LAST_BACKUP_KEY);

      if (!lastBackupTime) {
        console.log("No last backup time found");
        nudgeBackup();
      }
    }

    checkStorageIntegrity();

    function cleanupCompletedTodos() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let cleanupPerformed = false;

      appData.forEach((project) => {
        project.lists.forEach((list) => {
          if (list.items) {
            const originalLength = list.items.length;
            list.items = list.items.filter((item) => {
              if (!item) return false;
              if (item.type !== "todo") return true;
              if (!item.completed) return true;

              if (item.completedAt) {
                const completionDate = new Date(item.completedAt);
                return completionDate >= today;
              }
              return true;
            });
            if (list.items.length < originalLength) cleanupPerformed = true;
          }

          if (list.subLists) {
            list.subLists.forEach((subList) => {
              if (subList.items) {
                const originalLength = subList.items.length;
                subList.items = subList.items.filter((item) => {
                  if (!item) return false;
                  if (item.type !== "todo") return true;
                  if (!item.completed) return true;

                  if (item.completedAt) {
                    const completionDate = new Date(item.completedAt);
                    return completionDate >= today;
                  }
                  return true;
                });
                if (subList.items.length < originalLength) cleanupPerformed = true;
              }
            });
          }
        });
      });

      if (cleanupPerformed) {
        saveData();
        renderProjects();
      }
    }

    function nudgeBackup() {
      const autoBackupBtn = document.getElementById("autoBackupBtn");
      if (
        autoBackupBtn &&
        !autoBackupBtn.classList.contains("backup-nudge")
      ) {
        autoBackupBtn.classList.add("backup-nudge");
        autoBackupBtn.title = " Please backup your data!";
        autoBackupBtn.innerHTML = " Backup Needed";

        autoBackupBtn.addEventListener(
          "click",
          () => {
            autoBackupBtn.classList.remove("backup-nudge");
            autoBackupBtn.innerHTML = '<i class="fa-solid fa-file-export"></i>';
            setTimeout(nudgeBackup, 60 * 60 * 1000);
          },
          { once: true }
        );
      }
    }

    function renderSingleProject(project) {
      const projectIndex = appData.findIndex(p => p.id === project.id);
      if (projectIndex === -1) return;

      const existingProject = Array.from(projectsContainer.children).find(
        el => el.querySelector('.project-header .editable').textContent === project.name
      );
      const currentIndex = Array.from(projectsContainer.children).indexOf(existingProject);

      if (existingProject) {
        if (currentIndex !== projectIndex) {
          const timelineContainer = existingProject.querySelector('.timeline-container');
          const nextSibling = projectsContainer.children[projectIndex] || null;
          projectsContainer.insertBefore(existingProject, nextSibling);
          return;
        }

        const timelineContainer = existingProject.querySelector('.timeline-container');
        existingProject.remove();

        const newProjectElement = document.createElement('div');
        createProject(project, newProjectElement);

        if (timelineContainer) {
          const newTimeline = newProjectElement.querySelector('.timeline-container');
          if (newTimeline) {
            newTimeline.replaceWith(timelineContainer);
          }
        }

        const nextSibling = projectsContainer.children[projectIndex] || null;
        projectsContainer.insertBefore(newProjectElement, nextSibling);
        return;
      }

      const newProjectElement = document.createElement('div');
      createProject(project, newProjectElement);
      const nextSibling = projectsContainer.children[projectIndex] || null;
      projectsContainer.insertBefore(newProjectElement, nextSibling);
    }

    function initTutorial() {
      if (localStorage.getItem('tutorialShown')) {
        return;
      }

      if (appData.length === 0) {
        const sampleProject = {
          id: Date.now(),
          name: "My First Project",
          lists: [
            {
              id: Date.now() + 1,
              name: "To Do",
              items: [
                {
                  id: Date.now() + 2,
                  type: "todo",
                  content: "Try dragging this task to another list!",
                  completed: false
                }
              ]
            },
            {
              id: Date.now() + 3,
              name: "In Progress",
              items: []
            },
            {
              id: Date.now() + 4,
              name: "Done",
              items: []
            }
          ]
        };
        appData.push(sampleProject);
        saveData();
        renderProjects();
      }

      setTimeout(() => {
        const intro = introJs();

        intro.setOptions({
          steps: [
            {
              title: 'Welcome to Taskan! ',
              intro: "Taskan is a simple and easy to use task manager that helps you stay on top of your tasks. Taskan is an offline only app that stores your data locally on your device making it secure and private. You can export your data and import it in another device. Let's take a quick tour to help you get started with organizing your tasks.",
              tooltipClass: 'hide-back-button welcome-step'
            },
            {
              element: '#addProjectBtn',
              title: 'Create Projects',
              intro: 'Start by creating a new project. You can define the timeline here.',
              position: 'bottom'
            },
            {
              element: '.project:first-child .add-list-btn',
              title: 'Add Lists',
              intro: 'Within each project, you can create multiple lists to organize your tasks.',
              position: 'left'
            },
            {
              element: '.list:first-child button[title="Add Sub-list',
              title: 'Sub Lists',
              intro: 'You can add a sub list inside a list to further group tasks.',
              position: 'right'
            },
            {
              element: '.list:first-child button[title="New Todo"]',
              title: 'Add Tasks',
              intro: 'Add todos or notes to your lists. You can track time, set due dates, and more!',
              position: 'left'
            },
            {
              element: '.list-items .list-item:first-child',
              title: 'Manage Tasks',
              intro: 'Drag and drop tasks between lists, edit them, track time, or mark them as complete.',
              position: 'right'
            },
            {
              element: '.list-items .list-item:first-child',
              title: 'Task Options',
              intro: 'Hover over a task to see options for editing, timing, coloring, and more.',
              position: 'right'
            },
            {
              element: '#themeToggleBtn',
              title: 'Customize',
              intro: 'Switch between light and dark themes for comfortable viewing.',
              position: 'bottom'
            },
            {
              element: '#autoBackupBtn',
              title: 'Keep Your Data Safe',
              intro: 'Export your data regularly to keep your tasks backed up.',
              position: 'bottom'
            },
            {
              element: '#importDataBtn',
              title: 'Import Data',
              intro: 'Import your data from a backup file.',
              position: 'bottom'
            },
            {
              title: 'Ready to Go! ',
              intro: "That's it! You're ready to start organizing your tasks. Need help? Look for tooltips when hovering over buttons."
            }
          ],
          showProgress: true,
          showBullets: false,
          disableInteraction: false,
          hideNext: false,
          hidePrev: false,
          exitOnOverlayClick: false,
          exitOnEsc: false,
          skipLabel: '',
          tooltipClass: 'custom-tooltip',
          onbeforechange: function (targetElement) {
            setTimeout(() => {
              const prevButton = document.querySelector('.introjs-prevbutton');
              if (prevButton) {
                prevButton.style.display = this._currentStep === 0 ? 'none' : 'inline-block';
              }
            }, 0);
          }
        });

        intro.start();
        intro.oncomplete(() => {
          localStorage.setItem('tutorialShown', 'true');
        });

        let skipButtonClicked = false;

        document.addEventListener('click', function (e) {
          if (e.target.classList.contains('introjs-skipbutton')) {
            skipButtonClicked = true;
          }
        }, true);

        intro.onexit(function () {
          if (skipButtonClicked) {
            localStorage.setItem('tutorialShown', 'true');
          }
          skipButtonClicked = false;
        });
      }, 1000);
    }

    document.addEventListener('DOMContentLoaded', function () {
      setTheme(currentTheme);

      const themeToggleBtn = document.getElementById('themeToggleBtn');
      themeToggleBtn.innerHTML = currentTheme === "dark" 
        ? '<i class="fas fa-sun"></i>' 
        : '<i class="fas fa-moon"></i>';

      themeToggleBtn.addEventListener('click', () => {
        const newTheme = currentTheme === "light" ? "dark" : "light";
        setTheme(newTheme);
        themeToggleBtn.innerHTML = newTheme === "dark" 
          ? '<i class="fas fa-sun"></i>' 
          : '<i class="fas fa-moon"></i>';
      });

      Coloris({
        themeMode: currentTheme,
        alpha: false,
        formatToggle: false,
        clearButton: false,
        defaultColor: '#f4a261',
        format: 'hex',
        focusInput: false,
        parent: 'body',
        swatches: [
          '#f4a261',
          '#2a9d8f',
          '#e76f51',
          '#e9c46a',
          '#264653',
          '#ef476f',
          '#ffd166',
          '#06d6a0',
          '#118ab2',
          '#073b4c',
        ]
      });

      Coloris.setInstance('[data-coloris]', {
        theme: 'default',
        themeMode: currentTheme,
        position: 'bottom-start',
        margin: 2,
      });

      document.addEventListener('coloris:show', event => {
        const preview = document.querySelector('.color-preview');
        if (preview) {
          const rect = preview.getBoundingClientRect();
          const picker = document.querySelector('.clr-picker');
          if (picker) {
            requestAnimationFrame(() => {
              picker.style.position = 'fixed';
              picker.style.left = `${rect.left}px`;
              picker.style.top = `${rect.bottom + 5}px`;
              picker.style.margin = '0';
            });
          }
        }
      });

      document.addEventListener('coloris:change', event => {
        const preview = document.querySelector('.color-preview');
        if (preview) {
          preview.style.backgroundColor = event.detail.color;
        }
      });
    });

    function updateBackupStatus(now) {
      const formattedDate = now.toLocaleString(navigator.language, {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      });
      localStorage.setItem(LAST_BACKUP_KEY, formattedDate);

      const autoBackupBtn = document.getElementById("autoBackupBtn");
      if (autoBackupBtn) {
        autoBackupBtn.classList.remove("backup-nudge");
      }

      setTimeout(nudgeBackup, 60 * 60 * 1000);
    }

    function formatCompactDate(date) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      if (date.getTime() === today.getTime()) {
        return 'Today';
      } else if (date.getTime() === tomorrow.getTime()) {
        return 'Tomorrow';
      } else {
        return date.toLocaleDateString('default', { 
          month: 'short', 
          day: 'numeric' 
        });
      }
    }

    function handleDragOver(e) {
      e.stopPropagation();
      e.preventDefault();
      const draggingItem = document.querySelector(".dragging");
      if (!draggingItem || draggingItem === this) return;

      removePlaceholders();

      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;

      if (e.clientY < midY) {
        const placeholder = createPlaceholder();
        this.before(placeholder);
      } else {
        const placeholder = createPlaceholder();
        this.after(placeholder);
      }
    }

    function handleDragLeave(e) {
      e.stopPropagation();
      this.classList.remove("drop-highlight-top", "drop-highlight-bottom");
    }

    function handleDrop(e, list, container, project) {
      e.preventDefault();
      e.stopPropagation();

      try {
        const { itemId, listId, isSubListItem, parentListId } = JSON.parse(
          e.dataTransfer.getData("text/plain")
        );

        let sourceList;
        let sourceItems;

        if (isSubListItem) {
          const parentList = appData
            .flatMap((p) => p.lists)
            .find((l) => l.id === parentListId);

          if (parentList && parentList.subLists) {
            sourceList = parentList.subLists.find((sl) => sl.id === listId);
            if (sourceList) {
              sourceItems = sourceList.items;
            }
          }
        } else {
          sourceList = appData
            .flatMap((p) => p.lists)
            .find((l) => l.id === listId);
          if (sourceList) {
            sourceItems = sourceList.items;
          }
        }

        if (!sourceItems) return;
        const draggedItem = sourceItems.find((i) => i.id === itemId);
        if (!draggedItem) return;

        sourceItems = sourceItems.filter((i) => i.id !== itemId);
        if (isSubListItem) {
          sourceList.items = sourceItems;
        } else {
          sourceList.items = sourceItems;
        }

        const placeholder = container.querySelector(".drop-placeholder");
        if (placeholder) {
          const items = Array.from(container.children);
          const placeholderIndex = items.indexOf(placeholder);

          list.items.splice(placeholderIndex, 0, draggedItem);
        } else {
          list.items.push(draggedItem);
        }

        saveData();
        renderSingleProject(project);
      } catch (err) {
        console.error("Error during drag and drop:", err);
      }
    }

    function getContrastColor(hexcolor) {
      hexcolor = hexcolor.replace("#", "");
      
      const r = parseInt(hexcolor.substr(0, 2), 16);
      const g = parseInt(hexcolor.substr(2, 2), 16);
      const b = parseInt(hexcolor.substr(4, 2), 16);
      
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      return luminance > 0.5 ? "#000000" : "#ffffff";
    }
  </script>
</body>

</html>